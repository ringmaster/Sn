<div x-data="{
  posts: [],
  currentPage: 1,
  totalPages: 1,
  total: 0,
  perPage: 10,
  selectedRepo: '',
  loading: false,
  async fetchPosts() {
    if (!this.selectedRepo) return;
    this.loading = true;
    try {
      const response = await fetch(`{{BASE_PATH}}/api/posts?repo=${encodeURIComponent(this.selectedRepo)}&page=${this.currentPage}&per_page=${this.perPage}`);
      if (response.ok) {
        const data = await response.json();
        this.posts = data.items || [];
        this.currentPage = data.page;
        this.totalPages = data.pages;
        this.total = data.total;
      } else {
        bulmaToast.toast({ message: 'Failed to load posts', type: 'is-danger' });
      }
    } catch (error) {
      console.error('Error fetching posts:', error);
      bulmaToast.toast({ message: 'Error loading posts', type: 'is-danger' });
    } finally {
      this.loading = false;
    }
  },
  prevPage() {
    if (this.currentPage > 1) {
      this.currentPage--;
      this.fetchPosts();
    }
  },
  nextPage() {
    if (this.currentPage < this.totalPages) {
      this.currentPage++;
      this.fetchPosts();
    }
  },
  editPost(post) {
    // Set Alpine store for SPA navigation
    Alpine.store('editPost').repo = post.repo;
    Alpine.store('editPost').slug = post.slug;
    // Also save to sessionStorage for page reload support
    sessionStorage.setItem('editPost', JSON.stringify({ repo: post.repo, slug: post.slug }));
    window.PineconeRouter.context.navigate('/compose');
  },
  formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  },
  init() {
    $watch('$store.api.repoNames', (repoNames) => {
      if (!this.selectedRepo && repoNames && repoNames.length > 0) {
        this.selectedRepo = repoNames[0];
      }
    });
    $watch('selectedRepo', () => {
      this.currentPage = 1;
      this.fetchPosts();
    });
    if (this.$store.api.repoNames.length > 0) {
      this.selectedRepo = this.$store.api.repoNames[0];
    }
  }
}">
  <nav class="panel">
    <p class="panel-tabs">
      <template x-for="repoName in $store.api.repoNames" :key="repoName">
        <a :class="selectedRepo === repoName ? 'is-active' : ''"
           @click="selectedRepo = repoName"
           x-text="repoName"></a>
      </template>
    </p>

    <div x-show="loading" class="panel-block has-text-centered">
      <span class="icon">
        <i class="fas fa-spinner fa-pulse"></i>
      </span>
      <span>Loading...</span>
    </div>

    <div x-show="!loading && posts.length === 0 && selectedRepo" class="panel-block">
      <p class="has-text-grey">No posts found in this repository.</p>
    </div>

    <template x-for="post in posts" :key="post.id">
      <a class="panel-block" @click="editPost(post)">
        <div class="is-flex is-flex-direction-column is-align-items-start" style="width: 100%;">
          <div class="is-flex is-justify-content-space-between is-align-items-center" style="width: 100%;">
            <strong x-text="post.title"></strong>
            <span class="icon has-text-grey is-small">
              <i class="fas fa-edit"></i>
            </span>
          </div>
          <div class="is-size-7 has-text-grey">
            <span x-text="formatDate(post.date)"></span>
            <template x-if="post.authors && post.authors.length > 0">
              <span> &bull; <span x-text="post.authors.join(', ')"></span></span>
            </template>
          </div>
        </div>
      </a>
    </template>

    <div class="panel-block" x-show="totalPages > 1">
      <nav class="pagination is-small is-centered" role="navigation" aria-label="pagination" style="width: 100%;">
        <a class="pagination-previous" :disabled="currentPage <= 1" @click="prevPage">Previous</a>
        <a class="pagination-next" :disabled="currentPage >= totalPages" @click="nextPage">Next</a>
        <ul class="pagination-list">
          <li>
            <span class="pagination-link is-current" x-text="currentPage + ' / ' + totalPages"></span>
          </li>
        </ul>
      </nav>
    </div>
  </nav>
</div>
